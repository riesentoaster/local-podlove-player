<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Podlove Player for Local Files</title>
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        form {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        #player {
            width: 100%;
            min-height: 200px;
        }
    </style>
    <script src="https://cdn.podlove.org/web-player/5.x/embed.js"></script>
    <script>
        async function loadVTT(file) {
            const request = await fetch(URL.createObjectURL(file));
            const response = await request.text();
            const lines = response.split('\n\n');
            if (lines[0] !== 'WEBVTT') throw new Error('Invalid VTT file');
            return lines
                .slice(1)
                .filter(line => line.trim().length > 0)
                .map(line => {
                    const sublines = line.split('\n');
                    if (sublines.length !== 2) throw new Error('Invalid VTT file, line: ' + sublines);
                    const times = sublines[0].split('-->');
                    if (times.length !== 2) throw new Error('Invalid VTT file because of an invalid time entry, line: ' + sublines[0]);
                    return {
                        start: times[0].trim(),
                        end: times[1].trim(),
                        text: sublines[1].trim()
                    };
                });
        }

        async function handleUpload() {
            const audioFile = document.getElementById('audioFile').files[0];
            const vttFile = document.getElementById('vttFile').files[0];

            const episodeConfig = {
                version: 5,
                title: audioFile.name.split('.').slice(0, -1).join('.'),
                audio: [{
                    url: URL.createObjectURL(audioFile),
                    mimeType: audioFile.type,
                    size: audioFile.size
                }],
                transcripts: vttFile ? await loadVTT(vttFile) : []
            };

            podlovePlayer("#player", episodeConfig, { version: 5 });
        }
    </script>
</head>

<body>
    <form onsubmit="handleUpload(); return false;">
        <label for="audioFile">Audio File:</label>
        <input required type="file" id="audioFile" accept=".mp3,.m4a,.ogg,.wav,.aac,.flac,.webm">
        <label for="vttFile">Transcript File (VTT):</label>
        <input type="file" id="vttFile" accept=".vtt">
        <button type="submit">Load Player</button>
    </form>
    <div id="player"></div>
</body>

</html>
